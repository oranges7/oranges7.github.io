---
title: 单细胞下游分析
date: 2026-01-14
share: "true"
dir: post
image:
description:
tags:
  - 单细胞
---
## 导入包和函数
```R
# ========== 0.导入包和函数==========

mycol22 <- c("#b0d45d","#356d67","#42465c","#5066a1",
             "#76afda","#ffc556",
             "#f06152","#eb998b","#a14462","#cca69c",
             "#9e6c69","#7d4444","#562e3c","#a14462","#eb998b",
             "#fddbc8","#356d67","#4c9568",
             "#7fb961","#b0d45d","#ffe788",
             "#f06152","#7d4444","#9e6c69","#cca69c",
             "#5066a1","#76afda","#e8743c","#2873B3","#2EBEBE","#b20000","#74B346","#167153","#7D4444","#A14462","#8264CC",
             "#BD6263","#8EA325","#A9D179","#84CAC0","#F5AE6B","#BCB8D3","#4387B5",
             "#E64B35B2", "#4DBBD5B2" ,"#00A087B2", "#3C5488B2", "#F39B7FB2",
             "#8491B4B2", "#91D1C2B2", "#DC0000B2", "#7E6148B2",
             "#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2",
             "#D55E00", "#CC79A7",
             "#004529","#088247","#7CC767",
             "#223D6C","#5D90BA","#9ecae1",
             "#8c510a","#bf812d","#D8D155",
             "#b30000","#d73027","#fc9272",
             "#7A142C","#E0367A","#df65b0",
             "#4a1486","#6a51a3","#9e9ac8",
             "#252525","#737373","#bdbdbd")
mycol22 <- unique(mycol22)
save_plots <- function(
    filename,      # 基础文件名(不含扩展名)
    plot,          # 要保存的图形对象(ggplot或grid对象)
    path = ".",    # 保存路径,默认当前目录
    width = 7.2,   # 宽度(英寸)
    height = 4.8,  # 高度(英寸)
    dpi = 600,     # PNG分辨率
    formats = c("pdf", "png")  # 支持保存的格式
) {
  library(ggplot2)
  library(grid)
  
  # 创建目录(如果不存在)
  if (!dir.exists(path)) {
    dir.create(path, recursive = TRUE)
  }
  
  # 判断是否为ggplot对象
  is_ggplot <- inherits(plot, "ggplot")
  
  # 遍历所有需要保存的格式
  for (fmt in formats) {
    full_path <- file.path(path, paste0(filename, ".", fmt))
    
    if (is_ggplot) {
      # 如果是ggplot对象,使用ggsave
      switch(fmt,
             "pdf" = ggsave(full_path, plot, width = width, height = height),
             "png" = ggsave(full_path, plot, width = width, height = height, dpi = dpi, bg = "white"),
             "tiff" = ggsave(full_path, plot, width = width, height = height, dpi = dpi, bg = "white"),
             warning(paste("Unsupported format:", fmt))
      )
    } else {
      # 如果是grid对象(如pheatmap),使用传统图形设备
      switch(fmt,
             "pdf" = {
               pdf(full_path, width = width, height = height)
               print(plot)
               dev.off()
             },
             "png" = {
               png(full_path, width = width * dpi, height = height * dpi, res = dpi, bg = "white")
               print(plot)
               dev.off()
             },
             "tiff" = {
               tiff(full_path, width = width * dpi, height = height * dpi, res = dpi, bg = "white")
               print(plot)
               dev.off()
             },
             warning(paste("Unsupported format:", fmt))
      )
    }
    
    message(paste("Saved:", full_path))
  }
  
  invisible(NULL)
}
library(Seurat)
library(dplyr)
library(ggplot2)
library(tidydr)
library(patchwork)
library(scop)
options(reticulate.conda_binary = "/BioData/00.Software/12.anaconda/anaconda3/bin/conda")
```
## 数据读取与质控
数据读取有多种类型，需要根据实际情况进行读取
```R
# ========== 1.数据导入==========
raw_counts <- Read10X(data.dir = "/xxx/filter_matrix/")
obj1 <- CreateSeuratObject(
  counts = raw_counts,
  project = "NC1",
  min.cells = 3
)
raw_counts <- Read10X(data.dir = "/xxx/filter_matrix/")
obj2 <- CreateSeuratObject(
  counts = raw_counts,
  project = "NC2",
  min.cells = 3
)
raw_counts <- Read10X(data.dir = "/xxx/filter_matrix/")
obj3 <- CreateSeuratObject(
  counts = raw_counts,
  project = "NC3",
  min.cells = 3
)
merged <- merge(obj1, 
                y = c(obj2,obj3),
                add.cell.ids = c("NC1", "NC2", "NC3"),
                project = "merged")


table(merged$orig.ident)
merged$Sample <- merged$orig.ident
merged <- JoinLayers(merged)

# ========== 2.质控==========
species <- "Mouse"

if (species == "Mouse") {
  merged[["percent.mt"]] <- PercentageFeatureSet(merged, pattern = "^mt-")
} else if (species == "Human") {
  merged[["percent.mt"]] <- PercentageFeatureSet(merged, pattern = "^MT-")
} else {
  stop("Unsupported species. Please specify 'Mouse' or 'Human'.")
}
v1 <- VlnPlot(merged,
              features = c("nFeature_RNA", "nCount_RNA", "percent.mt"),
              ncol = 3,group.by = "orig.ident",cols = mycol22,
              pt.size = 0)&
  theme(axis.title.x = element_blank(),
        text = element_text(family = "serif"))
v1
save_plots(filename="00.VlnPlot",
           plot = v1,
           width = 7.9,   # 宽度（英寸）
           height = 4.75,
           path = "result"
)
merged <- subset(
  merged,
  subset = nFeature_RNA > 200 &
    nFeature_RNA < 6000 &
    nCount_RNA > 600 &
    nCount_RNA < 40000 &
    percent.mt < 15
)
v2 <- VlnPlot(merged,
              features = c("nFeature_RNA", "nCount_RNA", "percent.mt"),
              ncol = 3,group.by = "orig.ident",cols = mycol22,
              pt.size = 0)&
  theme(axis.title.x = element_blank(),
        text = element_text(family = "serif"))
v2
save_plots(filename="00.VlnPlot_qc",
           plot = v2,
           width = 7.9,   # 宽度（英寸）
           height = 4.75,
           path = "result"
)
saveRDS(merged, file = "01.merged_qc.rds")
#merged1 <- readRDS("01.merged_qc.rds")

merged <- NormalizeData(merged)
merged <- FindVariableFeatures(merged,
                               selection.method = "vst",
                               nfeatures = 3000)
#plan(sequential)
merged <- ScaleData(merged)
#merged <- ScaleData(merged, features = rownames(merged))
#plan(multisession, workers = 32)
merged <- RunPCA(merged,
                 npcs = 50,
                 verbose = FALSE)

#ElbowPlot(merged, ndims = 50,reduction = "pca")
e1 <- ElbowPlot(merged, ndims = 50,reduction = "pca")
e1
save_plots("01.ElbowPlot", e1,
           path = "result",
           width = 9.5,
           height = 6.2)
merged <- FindNeighbors(merged,
                        reduction = "pca",
                        dims = 1:30)

merged <- FindClusters(merged, resolution = 0.6)

merged <- RunUMAP(merged,
                  reduction = "pca", min.dist = 0.3,
                  dims = 1:30)
library(harmony)
merged <- RunHarmony(merged,
                     group.by.vars = "orig.ident", 
                     max_iter = 30)
e1 <- ElbowPlot(merged, ndims = 30,reduction = "harmony")
e1
dim_num <- 20
merged <- FindNeighbors(merged, 
                        reduction = "harmony",  # 使用harmony!
                        dims = 1:dim_num)
merged <- FindClusters(merged,resolution = 0.6)
merged <- RunUMAP(merged, 
                  reduction = "harmony",  
                  dims = 1:dim_num,
                  reduction.name = "umap_harmony")


p1<-CellDimPlot(
  srt = merged,
  group.by = c("seurat_clusters","Sample"),
  reduction = "umap_harmony",
  label = T,
  label_insitu =T,
  theme_use = "theme_blank"
)
p1

save_plots("02.umap_clusters", p1,
           path = "result",
           width = 7.8,
           height = 6.5)
```
## 聚类

## 注释

## 差异分析

## 细胞通讯

## 拟时序分析

## 转录因子分析
